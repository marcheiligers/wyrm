LEVEL0 = <<-MAP.lines.reverse
X.....XXXXXXX......XXXXXXX.....X
................................
................................
................................
X..............................X
X..............................X
X..............................X
................................
................................
................................
X..............................X
X..............................X
X..............................X
................................
................................
................................
X.....XXXXXXX......XXXXXXX.....X
MAP

LEVEL1 = <<-MAP.lines.reverse
X.....XXXXXXX......XXXXXXX.....X
................................
................................
................................
X.....X..................X.....X
X..............................X
X..............................X
................................
................................
................................
X..............................X
X..............................X
X.....X..................X.....X
................................
................................
................................
X.....XXXXXXX......XXXXXXX.....X
MAP

LEVEL2 = <<-MAP.lines.reverse
X.....XXXXXXX......XXXXXXX.....X
................................
................................
................................
X.....XX................XX.....X
X.....X..................X.....X
X..............................X
................................
................................
................................
X..............................X
X.....X..................X.....X
X.....XX................XX.....X
................................
................................
................................
X.....XXXXXXX......XXXXXXX.....X
MAP

LEVEL3 = <<-MAP.lines.reverse
X.....XXXXXXXX....XXXXXXXX.....X
................................
................................
................................
X.....XX.......XX.......XX.....X
X.....X..................X.....X
X..............................X
................................
................................
................................
X..............................X
X.....X..................X.....X
X.....XX.......XX.......XX.....X
................................
................................
................................
X.....XXXXXXXX....XXXXXXXX.....X
MAP

LEVEL4 = <<-MAP.lines.reverse
X...XXXXXXXXXX....XXXXXXXXXX...X
................................
................................
................................
X.....XX.......XX.......XX.....X
X.....X..................X.....X
X..............................X
................................
................................
................................
X..............................X
X.....X..................X.....X
X.....XX.......XX.......XX.....X
................................
................................
................................
X...XXXXXXXXXX....XXXXXXXXXX...X
MAP

LEVEL5 = <<-MAP.lines.reverse
X...XXXXXXXXXX....XXXXXXXXXX...X
................................
...............XX...............
X..............................X
X.....XX................XX.....X
X.....X..................X.....X
X..............................X
................................
................................
................................
X..............................X
X.....X..................X.....X
X.....XX................XX.....X
X..............................X
...............XX...............
................................
X...XXXXXXXXXX....XXXXXXXXXX...X
MAP

LEVEL6 = <<-MAP.lines.reverse
X..XXXXXXXXXXXXXXXXXXXXXXXXXX..X
................................
................................
X..............................X
X.....XXXXXX........XXXXXX.....X
X.....X..................X.....X
X..............................X
................................
................................
................................
X..............................X
X.....X..................X.....X
X.....XXXXXX........XXXXXX.....X
X..............................X
................................
................................
X..XXXXXXXXXXXXXXXXXXXXXXXXXX..X
MAP

LEVEL7 = <<-MAP.lines.reverse
X..XXXXXXXXXXXXXXXXXXXXXXXXXX..X
................................
................................
X..............................X
X.....XXXXXX........XXXXXX.....X
X.....X..................X.....X
X..............................X
X..............................X
X..............................X
X..............................X
X..............................X
X.....X..................X.....X
X.....XXXXXX........XXXXXX.....X
X..............................X
................................
................................
X..XXXXXXXXXXXXXXXXXXXXXXXXXX..X
MAP

LEVEL8 = <<-MAP.lines.reverse
X..XXXXXXXXXXXXXXXXXXXXXXXXXX..X
................................
..X..........................X..
X..............................X
X.....XXXXXX........XXXXXX.....X
X.....X..................X.....X
X.....X..................X.....X
X..............................X
X..............................X
X..............................X
X.....X..................X.....X
X.....X..................X.....X
X.....XXXXXX........XXXXXX.....X
X..............................X
..X..........................X..
................................
X..XXXXXXXXXXXXXXXXXXXXXXXXXX..X
MAP

LEVEL9 = <<-MAP.lines.reverse
XX.XXXXXXXXXXXXXXXXXXXXXXXXXX.XX
X..............................X
..X..........................X..
X..............................X
X.....XXXXXX........XXXXXX.....X
X.....X..................X.....X
X.....X..................X.....X
X..............................X
X..............................X
X..............................X
X.....X..................X.....X
X.....X..................X.....X
X.....XXXXXX........XXXXXX.....X
X..............................X
..X..........................X..
X..............................X
XX.XXXXXXXXXXXXXXXXXXXXXXXXXX.XX
MAP

LEVELS = [
  LEVEL0,
  LEVEL1,
  LEVEL2,
  LEVEL3,
  LEVEL4,
  LEVEL5,
  LEVEL6,
  LEVEL7,
  LEVEL8,
  LEVEL9
]

class Map
  include Easing

  TARGET = :map
  APPEAR_DURATION = 25

  def initialize
    @state = :hidden
    draw_level
  end

  def next_level!
    draw_level
    appear!
  end

  def draw_level
    rt = $args.render_target(TARGET)
    rt.primitives << walls

    @primitive = { x: 0, y: 0, w: 1280, h: 720, path: TARGET, source_x: 0, source_y: 0, source_w: 1280, source_h: 720 }.sprite!
  end

  def appear!
    @state = :appearing
    @start = $args.tick_count
  end

  def to_p
    case @state
    when :visible
      @primitive
    when :appearing
      ticks = $args.tick_count - @start
      @state = :visible if ticks >= APPEAR_DURATION
      @primitive[:a] = ease_in_quart(ticks, APPEAR_DURATION) * 255
      @primitive
    else
      nil
    end
  end

  def wall?(x, y)
    LEVELS[$game.level][y][x] == 'X'
  end

  private

  def walls
    [].tap do |walls|
      (GRID_HEIGHT - 1).times do |y| # top row of the grid is reserved for title and score
        GRID_WIDTH.times do |x|
          walls << block([x, y]) if LEVELS[$game.level][y][x] == 'X'
        end
      end
    end
  end

  def block(pos)
    { x: pos.x * GRID_SIZE, y: pos.y * GRID_SIZE, w: GRID_SIZE, h: GRID_SIZE, path: 'sprites/wall.png' }.sprite!
  end
end